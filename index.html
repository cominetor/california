
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clienti Mascus Bauma</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body {
      background-color: #f8f9fa;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    }
    .navbar {
      background-color: #1f3b57;
    }
    .navbar-brand {
      color: white;
      margin: auto;
    }
    .list-group-item {
      cursor: pointer;
    }
    .note-area, .foto-area {
      margin-top: 15px;
    }
    .foto-area img {
      max-width: 100%;
      height: auto;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <span class="navbar-brand mb-0 h1">Clienti Mascus Bauma</span>
  </nav>

  <div class="container mt-4">
    <input id="search" type="text" class="form-control mb-3" placeholder="Cerca cliente...">
    <div id="loading">Caricamento...</div>
    <ul id="clienti-list" class="list-group"></ul>

    <div id="dettagli-cliente" class="mt-4" style="display: none;">
      <h5 id="nome-cliente"></h5>
      <p><strong>Note:</strong></p>
      <textarea id="note" class="form-control note-area" rows="3"></textarea>
      <div class="form-check mt-2">
        <input class="form-check-input" type="checkbox" value="" id="visitato">
        <label class="form-check-label" for="visitato">Visitato</label>
      </div>
      <div class="foto-area mt-3">
        <label for="foto">Carica foto:</label>
        <input type="file" id="foto" accept="image/*" class="form-control">
        <img id="anteprima" class="mt-2"/>
      </div>
      <button class="btn btn-primary mt-3" onclick="salvaDettagli()">Salva</button>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://ypywsydqczhipblukehm.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlweXdzeWRxY3poaXBibHVrZWhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMwMTMzNTQsImV4cCI6MjA1ODU4OTM1NH0.7OFLPUuzQ1udqGpZ716n_b7cs3BZ-sOohX3igzpprEA";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let clienti = [];
    let clienteSelezionato = null;

    async function caricaClienti() {
      const { data, error } = await supabase
        .from("clienti")
        .select("*")
        .order("nome", { ascending: true });

      document.getElementById("loading").style.display = "none";

      if (error) {
        alert("Errore nel caricamento dei clienti");
        console.error(error);
        return;
      }

      clienti = data;
      mostraClienti(data);
    }

    function mostraClienti(lista) {
      const ul = document.getElementById("clienti-list");
      ul.innerHTML = "";

      lista.forEach(cliente => {
        const li = document.createElement("li");
        li.textContent = cliente.nome;
        li.className = "list-group-item";
        li.onclick = () => mostraDettagli(cliente);
        ul.appendChild(li);
      });
    }

    function mostraDettagli(cliente) {
      clienteSelezionato = cliente;
      document.getElementById("nome-cliente").textContent = cliente.nome;
      document.getElementById("note").value = cliente.note || "";
      document.getElementById("visitato").checked = cliente.visitato || false;
      document.getElementById("anteprima").src = cliente.foto_url || "";
      document.getElementById("dettagli-cliente").style.display = "block";
    }

    async function salvaDettagli() {
      const note = document.getElementById("note").value;
      const visitato = document.getElementById("visitato").checked;

      let foto_url = clienteSelezionato.foto_url;

      const fileInput = document.getElementById("foto");
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const { data, error } = await supabase.storage
          .from("fotoclienti")
          .upload(`${clienteSelezionato.id}/${file.name}`, file, {
            upsert: true
          });

        if (!error) {
          const { data: urlData } = supabase.storage
            .from("fotoclienti")
            .getPublicUrl(`${clienteSelezionato.id}/${file.name}`);
          foto_url = urlData.publicUrl;
        }
      }

      const { error } = await supabase
        .from("clienti")
        .update({ note, visitato, foto_url })
        .eq("id", clienteSelezionato.id);

      if (error) {
        alert("Errore nel salvataggio");
        console.error(error);
      } else {
        alert("Dati salvati");
        location.reload();
      }
    }

    document.getElementById("search").addEventListener("input", e => {
      const filtro = e.target.value.toLowerCase();
      const filtrati = clienti.filter(c => c.nome.toLowerCase().includes(filtro));
      mostraClienti(filtrati);
    });

    caricaClienti();
  </script>
</body>
</html>
