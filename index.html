
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Clienti Mascus Cloud</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background: #f4f4f4;
    }
    header {
      background-color: #2c3e50;
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.2rem;
    }
    input[type="text"] {
      width: 90%;
      margin: 1rem auto;
      display: block;
      padding: 0.5rem;
      font-size: 1rem;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .cliente {
      background: white;
      margin: 0.5rem;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      cursor: pointer;
      position: relative;
    }
    .visitato-icon {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 18px;
      color: green;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      width: 90%;
      max-height: 90%;
      overflow-y: auto;
      border-radius: 10px;
    }
    textarea {
      width: 100%;
      height: 100px;
    }
    button {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    .close-btn { background: #ccc; }
    .save-btn { background: #2c3e50; color: white; }
    img {
      max-width: 100%;
      margin-top: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
  </style>
</head>
<body>
<header>Clienti Mascus - Cloud</header>
<input type="text" id="searchInput" placeholder="Cerca cliente..." oninput="filterClienti()">
<div id="listaClienti"></div>

<div class="modal" id="schedaCliente">
  <div class="modal-content">
    <h2 id="clienteNome"></h2>
    <p><strong>Tipo:</strong> <span id="clienteTipo"></span></p>
    <p><strong>Hall:</strong> <span id="clienteHall"></span></p>
    <p><strong>CAP:</strong> <span id="clienteCAP"></span></p>
    <p><strong>Città:</strong> <span id="clienteCitta"></span></p>
    <p><strong>Paese:</strong> <span id="clientePaese"></span></p>
    <label><input type="checkbox" id="visitatoCheck"> Cliente visitato</label>
    <label>Note:</label>
    <textarea id="note"></textarea>
    <label>Foto biglietto da visita:</label>
    <input type="file" accept="image/*" id="fotoCliente" onchange="salvaImmagine()">
    <button onclick="rimuoviImmagine()" type="button" class="close-btn">Rimuovi foto</button>
    <div id="previewFoto"></div>
    <button onclick="salvaNote()" class="save-btn">Salva</button>
    <button onclick="chiudiScheda()" class="close-btn">Chiudi</button>
  </div>
</div>

<script>
  const supabase = supabase.createClient("https://ypywsydqczhipblukehm.supabase.co", 
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlweXdzeWRxY3poaXBibHVrZWhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMwMTMzNTQsImV4cCI6MjA1ODU4OTM1NH0.7OFLPUuzQ1udqGpZ716n_b7cs3BZ-sOohX3igzpprEA");

  let clienteAttivo = null;
  let tuttiClienti = [];

  async function caricaClienti() {
    const res = await supabase.from("clienti").select("*").order("nome", { ascending: true });
    tuttiClienti = res.data || [];
    renderClienti();
  }

  function renderClienti(filtrati = tuttiClienti) {
    const lista = document.getElementById("listaClienti");
    lista.innerHTML = "";
    filtrati.forEach(c => {
      const div = document.createElement("div");
      div.className = "cliente";
      div.innerHTML = `<h3>${c.nome}</h3><small>${c.città}</small>`;
      if (c.visitato) {
        const icon = document.createElement("span");
        icon.className = "visitato-icon";
        icon.innerText = "✓";
        div.appendChild(icon);
      }
      div.onclick = () => apriScheda(c);
      lista.appendChild(div);
    });
  }

  function filterClienti() {
    const query = document.getElementById("searchInput").value.toLowerCase();
    const filtrati = tuttiClienti.filter(c =>
      c.nome.toLowerCase().includes(query) || c.città.toLowerCase().includes(query)
    );
    renderClienti(filtrati);
  }

  function apriScheda(c) {
    clienteAttivo = c;
    document.getElementById("clienteNome").innerText = c.nome;
    document.getElementById("clienteTipo").innerText = c.tipo || "";
    document.getElementById("clienteHall").innerText = c.hall || "";
    document.getElementById("clienteCAP").innerText = c.cap || "";
    document.getElementById("clienteCitta").innerText = c.città || "";
    document.getElementById("clientePaese").innerText = c.paese || "";
    document.getElementById("note").value = c.note || "";
    document.getElementById("visitatoCheck").checked = c.visitato || false;
    mostraImmagine(c.foto_url);
    document.getElementById("schedaCliente").style.display = "flex";
  }

  function chiudiScheda() {
    document.getElementById("schedaCliente").style.display = "none";
  }

  function mostraImmagine(url) {
    const div = document.getElementById("previewFoto");
    div.innerHTML = url ? `<img src="${url}">` : "";
  }

  async function salvaImmagine() {
    const file = document.getElementById("fotoCliente").files[0];
    if (!file || !clienteAttivo) return;

    const filePath = clienteAttivo.nome.replace(/\s+/g, "_") + "/" + file.name;
    await supabase.storage.from("fotoclienti").upload(filePath, file, { upsert: true });
    const { data } = supabase.storage.from("fotoclienti").getPublicUrl(filePath);
    mostraImmagine(data.publicUrl);
    clienteAttivo.foto_url = data.publicUrl;
  }

  async function rimuoviImmagine() {
    if (!clienteAttivo) return;
    clienteAttivo.foto_url = null;
    mostraImmagine(null);
  }

  async function salvaNote() {
    const note = document.getElementById("note").value;
    const visitato = document.getElementById("visitatoCheck").checked;
    const aggiornato = {
      ...clienteAttivo,
      note: note,
      visitato: visitato,
      foto_url: clienteAttivo.foto_url || null
    };
    await supabase.from("clienti").upsert([aggiornato], { onConflict: 'nome' });
    chiudiScheda();
    caricaClienti();
  }

  caricaClienti();
</script>
</body>
</html>
